<%--
/**
 * Copyright (c) 2000-present Liferay, Inc. All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
--%>

<%@include file="/init.jsp" %>
<%@page import="com.liferay.portal.kernel.util.PortalUtil"%>
<%@page import="com.liferay.portal.kernel.util.PropsKeys"%>
<%@page import="com.liferay.portal.kernel.util.HtmlUtil"%>
<%@page import="co.com.colfondos.tech.util.format.FormatString"%>
<%@page import="co.com.colfondos.tech.ws.cache.liferay.CacheManagerParametros"%>
<%@page import="co.com.colfondos.tech.ws.cache.liferay.CacheManagerMensajes" %>
<%


String authenticationfailed						=HtmlUtil.unescape(CacheManagerMensajes.getInstance().getMensajeInMapCache("COLFONDOS_LOGIN","authentication-failed1"));
String thisaccounthasbeenlocked				=HtmlUtil.unescape(CacheManagerMensajes.getInstance().getMensajeInMapCache("COLFONDOS_LOGIN","this-account-has-been-locked"));
String youraccountisnotactive					=HtmlUtil.unescape(CacheManagerMensajes.getInstance().getMensajeInMapCache("COLFONDOS_LOGIN","your-account-is-not-active1"));
String nosuchuser										  =HtmlUtil.unescape(CacheManagerMensajes.getInstance().getMensajeInMapCache("COLFONDOS_LOGIN","no-such-user"));
String errorIp											  =HtmlUtil.unescape(CacheManagerMensajes.getInstance().getMensajeInMapCache("COLFONDOS_LOGIN","error-login-error-ip"));
String captchaVerificationFailed      =HtmlUtil.unescape(CacheManagerMensajes.getInstance().getMensajeInMapCache("COLFONDOS_LOGIN","captcha-verification-failed"));

HttpServletRequest httpReq = PortalUtil.getOriginalServletRequest(request); 
String campania = httpReq.getParameter("campania");
%>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>



<c:choose>
	<c:when test="<%= themeDisplay.isSignedIn() %>">

		<%
		String signedInAs = HtmlUtil.escape(user.getFullName());

		if (themeDisplay.isShowMyAccountIcon() && (themeDisplay.getURLMyAccount() != null)) {
			String myAccountURL = String.valueOf(themeDisplay.getURLMyAccount());

			signedInAs = "<a class=\"signed-in\" href=\"" + HtmlUtil.escape(myAccountURL) + "\">" + signedInAs + "</a>";
		}
		%>

		<liferay-ui:message arguments="<%= signedInAs %>" key="you-are-signed-in-as-x" translateArguments="<%= false %>" />
	</c:when>
	<c:otherwise>

		<%
		String formName = "loginForm";

		if (windowState.equals(LiferayWindowState.EXCLUSIVE)) {
			formName += "Modal";
		}

		String redirect = ParamUtil.getString(request, "redirect");

		String login = LoginUtil.getLogin(request, "login", company);
		String password = StringPool.BLANK;
		boolean rememberMe = ParamUtil.getBoolean(request, "rememberMe");

		if (Validator.isNull(authType)) {
			authType = company.getAuthType();
		}
		%>

		<portlet:actionURL name="/login/login" secure="<%= PropsValues.COMPANY_SECURITY_AUTH_REQUIRES_HTTPS || request.isSecure() %>" var="loginURL">
			<portlet:param name="mvcRenderCommandName" value="/login/login" />
		</portlet:actionURL>

		<aui:form action="<%= loginURL %>" autocomplete='<%= PropsValues.COMPANY_SECURITY_LOGIN_FORM_AUTOCOMPLETE ? "on" : "off" %>' cssClass="sign-in-form" method="post" name="<%= formName %>" onSubmit="event.preventDefault();">
			<aui:input name="saveLastPath" type="hidden" value="<%= false %>" />
			<aui:input name="redirect" type="hidden" value="<%= redirect %>" />
			<aui:input name="doActionAfterLogin" type="hidden" value="<%= portletName.equals(PortletKeys.FAST_LOGIN) ? true : false %>" />
			<aui:input name="campania" type="hidden" value="<%= campania %>" />
			<div class="inline-alert-container lfr-alert-container"></div>

			<c:choose>
				<c:when test='<%= SessionMessages.contains(request, "passwordSent") %>'>

					<div class="alert alert-success">
					   		<%=CacheManagerParametros.getInstance().getParametroInMapCache("envio.mensaje.olvido.clave") %>
					</div>
				</c:when>
				<c:when test='<%= SessionMessages.contains(request, "userAdded") %>'>

					<%
					String userEmailAddress = (String)SessionMessages.get(request, "userAdded");
					String userPassword = (String)SessionMessages.get(request, "userAddedPassword");
					%>

					<div class="alert alert-success">
						<c:choose>
							<c:when test="<%= company.isStrangersVerify() || Validator.isNull(userPassword) %>">
								<liferay-ui:message key="thank-you-for-creating-an-account" />

								<c:if test="<%= company.isStrangersVerify() %>">
									<liferay-ui:message arguments="<%= userEmailAddress %>" key="your-email-verification-code-was-sent-to-x" translateArguments="<%= false %>" />
								</c:if>
							</c:when>
							<c:otherwise>
								<liferay-ui:message arguments="<%= userPassword %>" key="thank-you-for-creating-an-account.-your-password-is-x" translateArguments="<%= false %>" />
							</c:otherwise>
						</c:choose>

						<c:if test="<%= PrefsPropsUtil.getBoolean(company.getCompanyId(), PropsKeys.ADMIN_EMAIL_USER_ADDED_ENABLED) %>">
							<liferay-ui:message arguments="<%= userEmailAddress %>" key="your-password-was-sent-to-x" translateArguments="<%= false %>" />
						</c:if>
					</div>
				</c:when>
				<c:when test='<%= SessionMessages.contains(request, "userPending") %>'>

					<%
					String userEmailAddress = (String)SessionMessages.get(request, "userPending");
					%>

					<div class="alert alert-success">
						<liferay-ui:message arguments="<%= userEmailAddress %>" key="thank-you-for-creating-an-account.-you-will-be-notified-via-email-at-x-when-your-account-has-been-approved" translateArguments="<%= false %>" />
					</div>
				</c:when>
			</c:choose>


			<!-- Mensaje de caducidad de clave -->
			<%if(request.getAttribute("numSemanasCaducidadClave")!=null){ %>
				<%
					String urlCambioClaveCaducidad="window.location='"+CacheManagerParametros.getInstance().getParametroInMapCache("url.redireccion.pagina.caducidadClave")+"'";
					String numSemanasCaducidadClave=(String)request.getAttribute("numSemanasCaducidadClave");
				%>
				<div class="data_update modal_col active">
					<div class="cont_general">
						<div class="gradient"></div>
						
						<span  id="close_modal" class="fa fa-times-circle close">&nbsp;</span>
						<form>
							<div class="cont_info">
								<h1 class="til_col">
									<%=CacheManagerParametros.getInstance().getParametroInMapCache("titulo.mensaje.caducidad.clave") %>
								</h1>				
								
								<p class="txt_col">
									<%=FormatString.getMessageFormat(
										CacheManagerParametros.getInstance().getParametroInMapCache("mensaje.caducidad.clave"),
										new Object[]{
													!CacheManagerParametros.getInstance().getParametroInMapCache("msg.nombre.politica.seguridad.xmumSem"+numSemanasCaducidadClave).isEmpty()?
															CacheManagerParametros.getInstance().getParametroInMapCache("msg.nombre.politica.seguridad.xmumSem"+numSemanasCaducidadClave):
																numSemanasCaducidadClave+" semanas"
												}) %>
								</p>
								<div class="cont_buttons">			
									<input type="button" class="btn_col" value="<liferay-ui:message key='ok'/>">									
								</div>
							</div>
						</form>
					</div>
				</div>
			<%} %>

			<liferay-ui:error exception="<%= AuthException.class %>" message="<%=authenticationfailed%>" />
			<liferay-ui:error exception="<%= CompanyMaxUsersException.class %>" message="unable-to-log-in-because-the-maximum-number-of-users-has-been-reached" />
			<liferay-ui:error exception="<%= CookieNotSupportedException.class %>" message="authentication-failed-please-enable-browser-cookies" />
			<liferay-ui:error exception="<%= NoSuchUserException.class %>" message="<%=nosuchuser %>" />
			<liferay-ui:error exception="<%= PasswordExpiredException.class %>" message="your-password-has-expired" />
			<liferay-ui:error exception="<%= UserEmailAddressException.MustNotBeNull.class %>" message="please-enter-an-email-address" />
			<liferay-ui:error exception="<%= UserLockoutException.LDAPLockout.class %>" message="<%=thisaccounthasbeenlocked %>" />

			<liferay-ui:error exception="<%= UserLockoutException.PasswordPolicyLockout.class %>">

				<%
				UserLockoutException.PasswordPolicyLockout ule = (UserLockoutException.PasswordPolicyLockout)errorException;
				%>

				<liferay-ui:message arguments="<%= ule.user.getUnlockDate() %>" key="<%=thisaccounthasbeenlocked %>" translateArguments="<%= false %>" />
			</liferay-ui:error>

			<liferay-ui:error exception="<%= UserPasswordException.class %>" message="<%=authenticationfailed %>" />
			<liferay-ui:error exception="<%= UserScreenNameException.MustNotBeNull.class %>" message="the-screen-name-cannot-be-blank" />
					
			<liferay-ui:error key="error-configuracion-ip-invalida" message="<%=errorIp %>" />			
			<liferay-ui:error key="account-is-not-active" message="<%=youraccountisnotactive %>" />	
			
			
			<liferay-ui:error key="error-cuenta-bloqueada-empleador61" message="<%=thisaccounthasbeenlocked %>" />	
			<liferay-ui:error key="error-cuenta-inactiva-empleador61" message="<%=youraccountisnotactive %>" />
	
	    <!-- Messages error captcha -->	
			<liferay-ui:error exception="<%= CaptchaTextException.class %>" message="<%= captchaVerificationFailed.isEmpty() ? "text-verification-failed" : captchaVerificationFailed %>" />
			<liferay-ui:error exception="<%= CaptchaConfigurationException.class %>" message="a-captcha-error-occurred-please-contact-an-administrator" />
		  
			<aui:fieldset>

				<%
				String loginLabel = null;

				if (authType.equals(CompanyConstants.AUTH_TYPE_EA)) {
					loginLabel = "email-address";
				}
				else if (authType.equals(CompanyConstants.AUTH_TYPE_SN)) {
					loginLabel = "screen-name";
				}
				else if (authType.equals(CompanyConstants.AUTH_TYPE_ID)) {
					loginLabel = "id";
				}
				%>

				<aui:input   cssClass="clearable" label="<%= loginLabel %>" name="login" showRequiredLabel="<%= false %>" type="text" value="" autocomplete="off">
					<aui:validator name="required" />
				</aui:input>
				
				<aui:input label="password" name="apellidoLog" onPaste="return false;"  autocomplete="off" showRequiredLabel="<%= false %>" type="text" value="">
					<aui:validator name="required" />
				</aui:input>
				
				<aui:input label="" name="password" autocomplete="off" type="text" value="" style="display:none;"></aui:input>
				
				<c:if test="<%= PropsValues.CAPTCHA_CHECK_PORTAL_CREATE_ACCOUNT %>">
					<portlet:resourceURL id="/login/captcha" var="captchaURL" />
					<liferay-captcha:captcha url="<%= captchaURL %>" />
				</c:if>

				<span id="<portlet:namespace />passwordCapsLockSpan" style="display: none;"><liferay-ui:message key="caps-lock-is-on" /></span>

			</aui:fieldset>

			<aui:button-row>
				<aui:button cssClass="btn-lg" type="submit" value="sign-in" />
			</aui:button-row>
		</aui:form>

		<liferay-util:include page="/navigation.jsp" servletContext="<%= application %>" />

		<aui:script sandbox="<%= true %>">
			var form = AUI.$(document.<portlet:namespace /><%= formName %>);

			form.on(
				'submit',
				function(event) {
					<c:if test="<%= Validator.isNotNull(redirect) %>">
						var redirect = form.fm('redirect');

						if (redirect) {
							var redirectVal = redirect.val();

							redirect.val(redirectVal + window.location.hash);
						}
					</c:if>

					submitForm(form);
				}
			);

			/*form.fm('password').on(
				'keypress',
				function(event) {
					Liferay.Util.showCapsLock(event, '<portlet:namespace />passwordCapsLockSpan');
				}
			);*/
			
			var formB = document.getElementById('<portlet:namespace /><%= formName %>');
			var password = formB.querySelector('#<portlet:namespace />password');
			var text = document.getElementById("<portlet:namespace />passwordCapsLockSpan");
			
			if (password) {
				password.addEventListener('keyup', checkCapsLock);
				password.addEventListener('mousedown', checkCapsLock);
			}
			
			function checkCapsLock(e) {
				try{					
					var caps_lock_on = e.getModifierState("CapsLock");			
					if(caps_lock_on == true){ 
						 	text.style.display = "block";
						 	text.style.color="red";
					}else{
							text.style.display = "none";
					}
				}catch(ex){			
				}
			}
			
			
			const idPasActuel = '<portlet:namespace />password';
			const idApellidoLogId = '<portlet:namespace />apellidoLog';
			
			function isNumber(value) {
			    return !isNaN(parseFloat(value)) && isFinite(value);
			}
			
			function inputMaskeInput(event){
			    if(event && event.data != null){
			        let tecla = event.data;
			        if(event.data.length > 1)
			            tecla = event.data.substring(1, event.data.length)
			        
			        let adicionar = false;
			        if(isNumber(tecla)){
			            if(event.inputType == 'insertText'){
			                adicionar = true;
			            }if(event.data.length > 1 && event.inputType == 'insertCompositionText'){
			                adicionar = true;
			            }
			        }else{
			            adicionar = true;
			        }
			
			        if(adicionar){
			            document.getElementById(idPasActuel).value = document.getElementById(idPasActuel).value + tecla
			        }
			    }
			}
			
			function inputMaskeUp(event){
				if(event){
			        if(document.getElementById(idApellidoLogId).value == ''){
			            document.getElementById(idPasActuel).value = ''
			        }
					if(event.key == "Backspace" || event.key == "Delete"){
						document.getElementById(idPasActuel).value = document.getElementById(idPasActuel).value.substring(0, document.getElementById(idApellidoLogId).value.length);
					}else{
						let inputPs = document.getElementById(idApellidoLogId);
						inputPs.value = inputPs.value.replace(/./g, '*');
					}
				}
			}
			
			const inputPs = document.getElementById(idApellidoLogId);
			inputPs.addEventListener("input", inputMaskeInput);
			inputPs.addEventListener("keyup", inputMaskeUp);
		</aui:script>
		<script>
			$( ".data_update.modal_col.active" ).click(function() {
				 $( ".data_update.modal_col.active" ).removeClass('active'); 
			});
			$( document ).ready(function() {
				const idApellidoLogId = '<portlet:namespace />apellidoLog';
				document.getElementById(idApellidoLogId).value = '';
				
				const idPasActuel = '<portlet:namespace />password';
				document.getElementById(idPasActuel).value = '';
			});
		</script>
	</c:otherwise>
</c:choose>
<!-- Version: 21-10-2022-12-01 -->
